- hosts: vpngw-aws
  user: fedora
  sudo: true
  vars:
  - aws_network_addr: 10.243.16.192
  - aws_network_mask: 255.255.255.224
  tasks:
  - template: src=vpcgw-local.conf dest=/etc/openvpn/vpcgw.conf
    delegate_to: localhost
    notify: restart local openvpn
  - yum: name=$item state=installed
    with_items:
    - openvpn
    - nmap
    - bridge-utils
    - system-config-firewall-base
    - selinux-policy-devel
  - file: path=/etc/selinux/local state=directory
  - copy: src=$item dest=/etc/selinux/local/
    with_items:
    - selinux/Makefile
    - selinux/local_tuntap.te
    - selinux/local_openvpn.te
    notify:
    - rebuild selinux modules
  - copy: src=vpcgw-aws.conf dest=/etc/openvpn/vpcgw.conf owner=root group=root mode=0644
    notify:
    - restart openvpn
  - copy: src=vpcgw.key dest=/etc/openvpn/vpcgw.key owner=root group=root mode=0400
    notify:
    - restart openvpn
  - copy: src=ip_forward.conf dest=/etc/sysctl.d/ip_forward.conf
    notify:
    - restart sysctl
  - copy: src=iptables dest=/etc/sysconfig/iptables
    notify:
    - restart iptables
  - service: name=openvpn@vpcgw state=running enabled=true
  handlers:
  - name: rebuild selinux modules
    command: make -C /etc/selinux/local install
  - name: restart sysctl
    command: /bin/systemctl restart systemd-sysctl
  - name: restart openvpn
    command: /bin/systemctl restart openvpn@vpcgw
  - name: restart iptables
    command: /bin/systemctl restart iptables
  - name: restart local openvpn
    service: name=openvpn@vpcgw state=restarted
    delegate_to: localhost

